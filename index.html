<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áâ©ÂìÅÊü•Ë©¢Á≥ªÁµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/storage.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SearchIcon = ({size = 20}) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        // ‰ΩøÁî®ÂÖ±‰∫´ÁöÑ storage.js ‰∏≠ÁöÑ storage Â∞çË±°

        const App = () => {
            const [searchTerm, setSearchTerm] = useState('');
            const [items, setItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState('');
            
            // ÈÅéÊøæÁâ©ÂìÅ
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.description?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.tags?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.location?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.category?.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            // ËºâÂÖ•Áâ©ÂìÅ
            const loadItems = async () => {
                try {
                    setIsLoading(true);
                    // Áõ¥Êé•Âæû localStorage ËÆÄÂèñ equipment-items
                    const result = await window.storage.get('equipment-items');
                    console.log('Âæû storage ËÆÄÂèñÁöÑÊï∏Êìö:', result);
                    const parsedItems = result && result.value ? JSON.parse(result.value) : [];
                    const validItems = Array.isArray(parsedItems) ? parsedItems : [];
                    console.log('Ëß£ÊûêÂæåÁöÑÁâ©ÂìÅÂàóË°®:', validItems);
                    setItems(validItems);
                    setFilteredItems(validItems);
                    setError('');
                } catch (error) {
                    console.error('ËºâÂÖ•Áâ©ÂìÅÂ§±Êïó:', error);
                    setError('ËºâÂÖ•Áâ©ÂìÅÂ§±Êïó: ' + error.message);
                } finally {
                    setIsLoading(false);
                }
            };
            
            // ÂàùÂßãÂåñËºâÂÖ•
            useEffect(() => {
                loadItems();
                
                // Áõ£ËÅΩ storage ‰∫ã‰ª∂ÔºåÁï∂ÂÖ∂‰ªñÈ†ÅÈù¢Êõ¥Êñ∞Êï∏ÊìöÊôÇËá™ÂãïÂà∑Êñ∞
                const handleStorageChange = (e) => {
                    console.log('Ê™¢Ê∏¨Âà∞ storage ËÆäÂåñ:', e);
                    if (e.key === 'equipment-items') {
                        console.log('equipment-items Â∑≤Êõ¥Êñ∞ÔºåÈáçÊñ∞Âä†ËºâÊï∏Êìö...');
                        loadItems();
                    }
                };
                
                // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
                window.addEventListener('storage', handleStorageChange);
                
                // Ê∑ªÂä†Ëá™ÂÆöÁæ©‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºåÁî®ÊñºÂêåÈ†ÅÈù¢ÂÖßÈÄö‰ø°
                const handleCustomStorageChange = () => {
                    console.log('Ê™¢Ê∏¨Âà∞Ëá™ÂÆöÁæ©Â≠òÂÑ≤‰∫ã‰ª∂ÔºåÈáçÊñ∞Âä†ËºâÊï∏Êìö...');
                    loadItems();
                };
                window.addEventListener('local-storage-update', handleCustomStorageChange);
                
                // Ê∏ÖÁêÜÂáΩÊï∏
                return () => {
                    window.removeEventListener('storage', handleStorageChange);
                    window.removeEventListener('local-storage-update', handleCustomStorageChange);
                };
            }, []);

            const handleSearch = (term) => {
                setSearchTerm(term);
                if (!term.trim()) {
                    setFilteredItems(items);
                    return;
                }
                const filtered = items.filter(item =>
                    item.name && item.name.toLowerCase().includes(term.toLowerCase())
                );
                setFilteredItems(filtered);
            };

            // Ê∏≤ÊüìÂä†ËºâÁãÄÊÖã
            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-white text-lg">ËºâÂÖ•‰∏≠...</div>
                    </div>
                );
            }
            
            // Ê∏≤ÊüìÈåØË™§ÁãÄÊÖã
            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-red-500/20 border border-red-500/50 text-white p-4 rounded-lg max-w-md w-full">
                            <div className="font-bold mb-2">ÁôºÁîüÈåØË™§</div>
                            <div className="mb-4">{error}</div>
                            <button
                                onClick={loadItems}
                                className="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded"
                            >
                                ÈáçË©¶
                            </button>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white/10 backdrop-blur-md rounded-2xl shadow-2xl p-6 mb-6 border border-white/20">
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-white">üîç Áâ©ÂìÅÊü•Ë©¢Á≥ªÁµ±</h1>
                            </div>
                            <div className="relative mb-6">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <SearchIcon />
                                </div>
                                <input
                                    type="text"
                                    className="w-full pl-10 pr-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="ÊêúÂ∞ãÁâ©ÂìÅÂêçÁ®±„ÄÅÊèèËø∞„ÄÅÊ®ôÁ±§Êàñ‰ΩçÁΩÆ..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    autoFocus
                                />
                            </div>

                            <div className="bg-white/10 backdrop-blur-md rounded-xl p-6 border border-white/20">
                                {items.length === 0 ? (
                                    <p className="text-white text-lg text-center">Â∞öÁÑ°Áâ©ÂìÅË≥áÊñô</p>
                                ) : searchTerm ? (
                                    <>
                                        <div className="bg-white/10 backdrop-blur-md rounded-xl p-6">
                                            {filteredItems.length === 0 ? (
                                                <p className="text-white text-lg text-center py-8">
                                                    {searchTerm ? 'Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÁâ©ÂìÅ' : 'Â∞öÁÑ°Áâ©ÂìÅË≥áÊñô'}
                                                </p>
                                            ) : (
                                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                    {filteredItems.map((item) => (
                                                        <div key={item.id} className="bg-white/5 rounded-lg p-4 border border-white/10 hover:border-blue-500/50 transition-colors group">
                                                            <div className="flex justify-between items-start mb-2">
                                                                <h3 className="text-xl font-semibold text-white">{item.name}</h3>
                                                                {item.status === 'unavailable' && (
                                                                    <span className="bg-red-500/20 text-red-300 text-xs px-2 py-1 rounded">
                                                                        Â∑≤Âá∫ÂÄü/ÈÅ∫Â§±
                                                                    </span>
                                                                )}
                                                            </div>
                                                            
                                                            {item.image && (
                                                                <div className="mb-3 overflow-hidden rounded-lg">
                                                                    <img 
                                                                        src={item.image} 
                                                                        alt={item.name} 
                                                                        className="w-full h-32 object-cover rounded-lg group-hover:scale-105 transition-transform duration-300"
                                                                        onError={(e) => {
                                                                            e.target.style.display = 'none';
                                                                        }}
                                                                    />
                                                                </div>
                                                            )}
                                                            
                                                            {item.description && (
                                                                <p className="text-gray-300 text-sm mb-3 line-clamp-2">
                                                                    {item.description}
                                                                </p>
                                                            )}
                                                            
                                                            <div className="text-sm text-gray-400 space-y-1">
                                                                <div className="flex items-center">
                                                                    <span className="font-medium w-16">Êï∏Èáè:</span>
                                                                    <span className="text-white">{item.quantity || 1}</span>
                                                                </div>
                                                                
                                                                {item.location && (
                                                                    <div className="flex items-center">
                                                                        <span className="font-medium w-16">‰ΩçÁΩÆ:</span>
                                                                        <span className="text-white">{item.location}</span>
                                                                    </div>
                                                                )}
                                                                
                                                                {item.category && (
                                                                    <div className="flex items-center">
                                                                        <span className="font-medium w-16">ÂàÜÈ°û:</span>
                                                                        <span className="text-white">{item.category}</span>
                                                                    </div>
                                                                )}
                                                                
                                                                {item.updatedAt && (
                                                                    <div className="text-xs text-gray-500 mt-2 pt-2 border-t border-white/10">
                                                                        Êõ¥Êñ∞Êñº: {new Date(item.updatedAt).toLocaleString()}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            
                                                            {item.tags && item.tags.trim() && (
                                                                <div className="flex flex-wrap gap-1 mt-3 pt-2 border-t border-white/10">
                                                                    {item.tags.split(',').filter(tag => tag.trim()).map((tag, i) => (
                                                                        <span key={i} className="bg-blue-900/50 text-blue-200 text-xs px-2 py-1 rounded">
                                                                            {tag.trim()}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-white text-lg text-center">
                                        Ë´ãËº∏ÂÖ•ÈóúÈçµÂ≠óÊêúÂ∞ãÁâ©ÂìÅ
                                    </p>
                                )}
                            </div>
                        </div>
                        
                        <div className="text-center text-white/50 text-sm">
                            <p>¬© 2025 Áâ©ÂìÅÊü•Ë©¢Á≥ªÁµ±</p>
                        </div>
                        
                        <div className="text-center text-white/50 text-sm mt-8">
                            <p>¬© 2025 Áâ©ÂìÅÊü•Ë©¢Á≥ªÁµ± | Ë≥áÊñôÊúÄÂæåÊõ¥Êñ∞: {new Date().toLocaleString()}</p>
                            <p className="mt-1">
                                ÈúÄË¶ÅÁÆ°ÁêÜÁâ©ÂìÅ? <a href="equipment-admin.html" className="text-blue-400 hover:underline">ÈªûÊ≠§ÁôªÂÖ•ÁÆ°ÁêÜÂæåÂè∞</a>
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // ÂàùÂßãÂåñÊáâÁî®
        ReactDOM.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>,
            document.getElementById('root')
        );
        
        // Ë®ªÂÜä Service Worker ‰ª•ÊîØÊåÅÈõ¢Á∑öÂäüËÉΩ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker Ë®ªÂÜäÊàêÂäü: ', registration.scope);
                }).catch(error => {
                    console.log('ServiceWorker Ë®ªÂÜäÂ§±Êïó: ', error);
                });
            });
        }
    </script>
</body>
</html>
